<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript" src="static/jquery-1.4.2.min.js"></script>
<script type="text/javascript"
    src="http://maps.google.com/maps/api/js?sensor=false">
</script>
<script type="text/javascript">
   var image_cache = new Array();
   function load_image(heading) {
      if (image_cache[heading] == null) {
         image_cache[heading] = new google.maps.MarkerImage(
            "http://www.google.com/intl/en_ALL/mapfiles/dir_" + heading + ".png",
            new google.maps.Size(24, 24), // size
            new google.maps.Point(0, 0), // origin
            new google.maps.Point(12, 12) //anchor
         );
      }
      return image_cache[heading];
   }

   var max_lat = null;
   var min_lat = null;
   var max_lng = null;
   var min_lng = null;

   function update_bounds(lat, lng) {
     if (max_lat == null || lat > max_lat ) { max_lat = lat; }
     if (min_lat == null || lat < min_lat ) { min_lat = lat; }

     if (max_lng == null || lng < max_lng ) { max_lng = lng; }
     if (min_lng == null || lng > min_lng ) { min_lng = lng; }
   }

   function initialize() {
    var latlng = new google.maps.LatLng(42.3, -71.1);
    var myOptions = {
      zoom: 11,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    function recenter () {
       if (max_lat != null && min_lat != null && max_lng != null && min_lng != null) {
          var sw = new google.maps.LatLng(min_lat, min_lng);
          var ne = new google.maps.LatLng(max_lat, max_lng);
          map.fitBounds(new google.maps.LatLngBounds(sw, ne));
       }
    }

    function draw_buses(map, busarr, route) {
 
     $.getJSON('/Buses?route=' + route, function(buses) {

        for (bus_no in buses) {
          var bus = buses[bus_no];
          var busid = route + ":" + bus.id;
          var bus_title = busid + " -- age " + bus.age;
          var blatlng = new google.maps.LatLng(bus.elat, bus.elon);

          if (busarr[busid] == null) {
            var bmarker = new google.maps.Marker({
              position: blatlng,
              title:bus_title + " (new)"
            });
            busarr[busid] = bmarker;
            bmarker.setMap(map);
          }
          
          busarr[busid].setIcon(load_image(bus.rhead));
          busarr[busid].setPosition(blatlng);
          busarr[busid].setTitle(bus_title);

          // only update for paths
          //update_bounds(bus.elat, bus.elng)
        }
      });
    }

    function draw_buses_continual(map, busarr, buses) {
      function draw() {
        draw_buses(map, busarr, buses);
      }
      setInterval(draw, 2 * 1000);
    }

    function draw_routes(map, route, busarr) {

      {% if shading %}
      $.getJSON('/Buses?route=' + route, function(buses) {
         var n_buses = buses.length;
         var opacity = n_buses/10;
         //var opacity = 1.0;
         var weight = n_buses/8+1;
         //var weight = n_buses/4+1;
      {% else %}
         var opacity = 1.0;
         var weight = 2.0;
      {% endif %}

         $.getJSON('/Paths?route=' + route, function(paths) {

            for (path_no in paths) {
               var coords = new Array();
               for (point_no in paths[path_no]) {
                   var point = paths[path_no][point_no];
                   update_bounds(point.lat, point.lng)
                   coords.push( new google.maps.LatLng(point.lat, point.lng) );
               }

               var buspath = new google.maps.Polyline({
                   path: coords,
                   strokeColor: "#FF0000",
                   strokeOpacity: opacity,
                   strokeWeight: weight
               });

               buspath.setMap(map);
               google.maps.event.addListener(buspath, "click", function() {
                 draw_buses(map, busarr, route);
               });

               recenter();
           }
           {% if buses %}
              draw_buses_continual(map, busarr, route);
           {% endif %}
         });

      {% if shading %}
      });
      {% endif %}
    }

    {% if all_routes %}
      $.getJSON('/Routes', function(routes) {
         for (route_no in routes) {
            draw_routes(map, routes[route_no], new Array());
         }
      });
    {% else %}
       {% for route in routes %}
          draw_routes(map, {{route}}, new Array());
       {% endfor %}
    {% endif %}

    
  }

</script>
</head>
<body onload="initialize()">
  <div id="map_canvas" style="width:100%; height:100%"></div>
</body> </html>
